<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>AI æ•°æ®åˆ†æåŠ©æ‰‹</title>
    <style>
        :root[data-theme="light"] {
            --bg: #f5f7fa;
            --card: #fff;
            --bd: #d6d9e0;
            --text: #111827;
            --muted: #64748b;
            --good: #16a34a;
            --bad: #dc2626;
            --warn: #ea580c;
            --primary: #2563eb;
            --shadow: 0 8px 18px rgba(0, 0, 0, .08);
        }

        :root[data-theme="dark"] {
            --bg: #0b1020;
            --card: #0f162e;
            --bd: #1d2b4a;
            --text: #e6eefc;
            --muted: #9aa6bf;
            --good: #22c55e;
            --bad: #ef4444;
            --warn: #f59e0b;
            --primary: #3b82f6;
            --shadow: 0 10px 30px rgba(0, 0, 0, .35);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
            background: transparent;
            color: var(--text);
            height: 100vh;
            overflow: hidden;
            transition: .3s;
        }

        .ai-chat-container {
            position: relative;
            display: flex;
            flex-direction: column;
            height: 100vh;
            border: 1px solid var(--bd);
            border-radius: 12px;
            background: var(--card);
            box-shadow: var(--shadow);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        /* ğŸŒˆ AI å›ç­”æ—¶ï¼šå…ˆç¼©å°æ›´å¤šï¼Œåœ†è§’è¾¹æ¡† */
        .ai-chat-container.ai-responding {
            /* ç¼©å°å®¹å™¨åˆ° 95% */
            transform: scale(0.95);
            border-radius: 16px;
            /* æµå…‰è¾¹æ¡† */
            border: 3px solid transparent;
            background: 
                linear-gradient(var(--card), var(--card)) padding-box,
                linear-gradient(
                    90deg,
                    #ff6b6b,
                    #feca57,
                    #48dbfb,
                    #ff9ff3,
                    #54a0ff,
                    #00d2d3,
                    #ff6b6b
                ) border-box;
            background-size: auto, 300% 300%;
            box-shadow:
                0 0 30px rgba(255, 107, 107, 0.4),
                0 0 50px rgba(72, 219, 251, 0.3),
                0 0 70px rgba(255, 159, 243, 0.2),
                0 10px 40px rgba(0, 0, 0, 0.15);
            /* åœ¨ç¼©å°çš„åŸºç¡€ä¸Šæµ®åŠ¨ */
            animation: gradientShift 4s ease infinite, floatingPulse 2s ease-in-out infinite;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes floatingPulse {
            0% { transform: scale(0.95) translateY(0); }
            50% { transform: scale(0.955) translateY(-3px); }
            100% { transform: scale(0.95) translateY(0); }
        }

        .ai-chat-header {
            padding: 16px 20px;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .ai-chat-header h3 {
            margin: 0;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .ai-clear-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .ai-clear-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .ai-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background: var(--bg);
        }

        .ai-message {
            margin-bottom: 16px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .ai-message.user {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .ai-message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 600;
        }

        .ai-message.user .ai-message-header {
            flex-direction: row-reverse;
        }

        .ai-message-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .ai-message.user .ai-message-avatar {
            background: var(--primary);
        }

        .ai-message.assistant .ai-message-avatar {
            background: var(--good);
        }

        .ai-message-content {
            padding: 12px 16px;
            border-radius: 12px;
            line-height: 1.6;
            word-wrap: break-word;
            max-width: 85%;
        }

        .ai-message.user .ai-message-content {
            background: var(--primary);
            color: white;
            margin-right: 32px;
            white-space: pre-wrap;
        }

        .ai-message.assistant .ai-message-content {
            background: var(--card);
            border: 1px solid var(--bd);
            color: var(--text);
            margin-left: 32px;
        }

        .ai-message-content strong {
            font-weight: 600;
        }

        .ai-message-content code {
            background: rgba(0, 0, 0, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        /* Markdown æ ·å¼ */
        .ai-message-content h1,
        .ai-message-content h2,
        .ai-message-content h3 {
            margin-top: 16px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .ai-message-content h1 { font-size: 1.5em; }
        .ai-message-content h2 { font-size: 1.3em; }
        .ai-message-content h3 { font-size: 1.1em; }

        .ai-message-content ul,
        .ai-message-content ol {
            margin: 8px 0;
            padding-left: 24px;
        }

        .ai-message-content li {
            margin: 4px 0;
        }

        .ai-message-content pre {
            background: rgba(0, 0, 0, 0.05);
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 8px 0;
        }

        .ai-message-content pre code {
            background: none;
            padding: 0;
        }

        .ai-message-content blockquote {
            border-left: 3px solid var(--primary);
            padding-left: 12px;
            margin: 8px 0;
            color: var(--muted);
        }

        .ai-message-content a {
            color: var(--primary);
            text-decoration: none;
        }

        .ai-message-content a:hover {
            text-decoration: underline;
        }

        /* æ€è€ƒè¿‡ç¨‹æ ·å¼ */
        .ai-thinking-section {
            background: rgba(147, 51, 234, 0.05);
            border: 1px solid rgba(147, 51, 234, 0.2);
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            font-size: 0.95em;
        }

        .ai-thinking-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #9333ea;
            cursor: pointer;
            user-select: none;
            margin-bottom: 8px;
        }

        .ai-thinking-toggle {
            font-size: 12px;
            transition: transform 0.2s;
        }

        .ai-thinking-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .ai-thinking-content {
            color: var(--muted);
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .ai-thinking-content.collapsed {
            display: none;
        }

        .ai-welcome {
            text-align: center;
            padding: 30px 20px 40px 20px;
            color: var(--muted);
        }

        /* è”å Logo æ ·å¼ */
        .ai-logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .ai-logo-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .ai-logo-item img {
            height: 60px;
            width: auto;
            object-fit: contain;
            transition: transform 0.3s;
        }

        .ai-logo-item img:hover {
            transform: scale(1.05);
        }

        .ai-logo-separator {
            font-size: 24px;
            color: var(--muted);
            font-weight: 300;
        }

        .ai-logo-label {
            font-size: 12px;
            color: var(--muted);
            font-weight: 500;
        }

        .ai-welcome-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text);
        }

        .ai-welcome-desc {
            font-size: 14px;
            color: var(--muted);
            line-height: 1.6;
        }

        .ai-suggestions-bar {
            padding: 12px 16px;
            background: var(--bg);
            border-top: 1px solid var(--bd);
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            flex-shrink: 0;
        }

        .ai-suggestion {
            padding: 8px 16px;
            background: var(--card);
            border: 1px solid var(--bd);
            border-radius: 16px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .ai-suggestion:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.3);
        }

        .ai-chat-input-area {
            padding: 16px;
            background: var(--card);
            border-top: 1px solid var(--bd);
            display: flex;
            gap: 12px;
            align-items: flex-end;
            flex-shrink: 0;
        }

        .ai-chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--bd);
            border-radius: 8px;
            background: var(--bg);
            color: var(--text);
            font-size: 14px;
            resize: none;
            min-height: 44px;
            max-height: 120px;
            font-family: inherit;
        }

        .ai-chat-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .ai-send-btn {
            padding: 12px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .ai-send-btn:hover {
            background: #1d4ed8;
        }

        .ai-send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .ai-stop-btn {
            background: #ef4444 !important;
        }

        .ai-stop-btn:hover {
            background: #dc2626 !important;
        }

        .ai-typing {
            margin-bottom: 16px;
        }

        .ai-typing-container {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: var(--card);
            border: 1px solid var(--bd);
            border-radius: 12px;
            margin-left: 32px;
        }

        .ai-typing-dots {
            display: flex;
            gap: 4px;
        }

        .ai-typing-dot {
            width: 8px;
            height: 8px;
            background: var(--primary);
            border-radius: 50%;
            animation: typing 1.4s ease-in-out infinite;
        }

        .ai-typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .ai-typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="ai-chat-container" id="aiChatContainer">
        <div class="ai-chat-header">
            <h3>
                <span>ğŸ¤–</span>
                <span>AI æ•°æ®åˆ†æåŠ©æ‰‹</span>
            </h3>
            <div class="ai-header-right">
                <button class="ai-clear-btn" onclick="clearChat()">ğŸ—‘ï¸ æ¸…ç©º</button>
            </div>
        </div>

        <div class="ai-chat-messages" id="aiChatMessages">
            <div class="ai-welcome">
                <!-- è”å Logo -->
                <div class="ai-logo-container" style="flex-direction: column; gap: 12px;">
                    <div class="ai-logo-item">
                        <img src="https://znhj.iepose.cn/resource/logo.png" alt="æ™ºèƒ½ç¯å¢ƒç›‘æµ‹ç³»ç»Ÿ" style="height: 40px;">
                        <div class="ai-logo-label">æ™ºèƒ½ç¯å¢ƒç›‘æµ‹ç³»ç»Ÿ</div>
                    </div>
                    <div class="ai-logo-separator" style="transform: rotate(0deg); font-size: 28px;">Ã—</div>
                    <div class="ai-logo-item">
                        <img src="https://znhj.iepose.cn/resource/deepseek.png" alt="DeepSeek AI" style="height: 40px;">
                        <div class="ai-logo-label">DeepSeek AI</div>
                    </div>
                </div>
                
                <div class="ai-welcome-title">æ¬¢è¿ä½¿ç”¨ AI æ•°æ®åˆ†æåŠ©æ‰‹</div>
                <div class="ai-welcome-desc">
                    æˆ‘å¯ä»¥å¸®ä½ åˆ†æå½“å‰åŠ è½½çš„ä¼ æ„Ÿå™¨æ•°æ®ï¼Œæä¾›æ´å¯Ÿå’Œå»ºè®®ã€‚<br>
                    <strong>ä½¿ç”¨æ­¥éª¤ï¼š</strong><br>
                    1ï¸âƒ£ ç¡®è®¤é¡¶éƒ¨æ¨¡å‹åç§°æ­£ç¡®<br>
                    2ï¸âƒ£ åŠ è½½ä¼ æ„Ÿå™¨æ•°æ®<br>
                    3ï¸âƒ£ å‘æˆ‘æé—®æˆ–ç‚¹å‡»ä¸‹æ–¹å¿«æ·é—®é¢˜
                </div>
            </div>
        </div>

        <div class="ai-suggestions-bar">
            <div class="ai-suggestion" onclick="sendSuggestion('åˆ†ææ¸©åº¦è¶‹åŠ¿')">ğŸ“ˆ åˆ†ææ¸©åº¦è¶‹åŠ¿</div>
            <div class="ai-suggestion" onclick="sendSuggestion('æ¹¿åº¦æ˜¯å¦æ­£å¸¸ï¼Ÿ')">ğŸ’§ æ¹¿åº¦æ˜¯å¦æ­£å¸¸ï¼Ÿ</div>
            <div class="ai-suggestion" onclick="sendSuggestion('æ€»ç»“æ•°æ®ç‰¹å¾')">ğŸ“Š æ€»ç»“æ•°æ®ç‰¹å¾</div>
            <div class="ai-suggestion" onclick="sendSuggestion('æœ‰ä»€ä¹ˆå¼‚å¸¸å—ï¼Ÿ')">âš ï¸ æœ‰ä»€ä¹ˆå¼‚å¸¸å—ï¼Ÿ</div>
        </div>

        <div class="ai-chat-input-area">
            <textarea 
                id="aiChatInput" 
                class="ai-chat-input" 
                placeholder="è¾“å…¥ä½ çš„é—®é¢˜"
                rows="1"
            ></textarea>
            <button id="aiSendBtn" class="ai-send-btn" onclick="handleSendClick()">
                <span>ğŸ“¤ å‘é€</span>
            </button>
        </div>
    </div>

    <script>
        let currentData = [];
        let selectedDeviceId = null;
        let deviceList = [];
        let isAISending = false;
        let aiChatHistory = [];
        let aiAbortController = null;
        const SERVER_HOST = 'znhj.iepose.cn';
        const AI_API_URL = `https://${SERVER_HOST}/api/ai/chat`;
        const AI_MODEL = 'deepseek-reasoner';
        
        // è°ƒè¯•æ—¥å¿—
        console.log('[AI Chat] é…ç½®ä¿¡æ¯:', {
            SERVER_HOST: SERVER_HOST,
            AI_API_URL: AI_API_URL,
            AI_MODEL: AI_MODEL
        });

        // ç›‘å¬æ¥è‡ªé¸¿è’™çš„æ¶ˆæ¯
        window.addEventListener('message', function(event) {
            try {
                const data = event.data;
                if (data && data.type === 'updateData') {
                    currentData = data.sensorData || [];
                    selectedDeviceId = data.selectedDeviceId || null;
                    deviceList = data.deviceList || [];
                    console.log('[AI Chat] æ”¶åˆ°æ•°æ®æ›´æ–°:', currentData.length, 'æ¡');
                }
            } catch (e) {
                console.error('[AI Chat] æ¶ˆæ¯è§£æå¤±è´¥:', e);
            }
        });

        // å‘é€å¿«æ·é—®é¢˜
        function sendSuggestion(text) {
            document.getElementById('aiChatInput').value = text;
            sendAIMessage();
        }

        // å¤„ç†å‘é€æŒ‰é’®ç‚¹å‡»
        function handleSendClick() {
            if (isAISending) {
                cancelAIStreaming();
            } else {
                sendAIMessage();
            }
        }

        // ä¸­æ–­ AI æµå¼å“åº”
        function cancelAIStreaming() {
            if (aiAbortController) {
                aiAbortController.abort();
            }
            isAISending = false;
            const sendBtn = document.getElementById('aiSendBtn');
            sendBtn.classList.remove('ai-stop-btn');
            sendBtn.innerHTML = '<span>ğŸ“¤ å‘é€</span>';
        }

        // å‘é€æ¶ˆæ¯åˆ° AI
        async function sendAIMessage() {
            if (isAISending) return;

            const input = document.getElementById('aiChatInput');
            const sendBtn = document.getElementById('aiSendBtn');
            const userMessage = input.value.trim();

            if (!userMessage) {
                alert('è¯·è¾“å…¥é—®é¢˜');
                return;
            }

            // ğŸ¯ æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
            if (!currentData || currentData.length === 0) {
                // é€šçŸ¥é¸¿è’™ç«¯æç¤ºç”¨æˆ·å¹¶æ’­æ”¾å¼¹è·³åŠ¨ç”»
                console.log('[NEED_LOAD_DATA]');
                return;
            }

            isAISending = true;
            aiAbortController = new AbortController();
            input.value = '';
            sendBtn.classList.add('ai-stop-btn');
            sendBtn.innerHTML = '<span>â¹ åœæ­¢</span>';

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addAIMessage('user', userMessage);
            aiChatHistory.push({ role: 'user', content: userMessage });

            // æ˜¾ç¤ºåŠ è½½ä¸­
            showAITyping('ğŸ’­ æ­£åœ¨æ€è€ƒ...');

            // ğŸŒˆ å¯åŠ¨æµå…‰è¾¹æ¡†æ•ˆæœ
            document.getElementById('aiChatContainer').classList.add('ai-responding');

            try {
                // å‡†å¤‡æ•°æ®æ‘˜è¦
                const dataSummary = prepareDataSummary();

                // æ„å»ºç³»ç»Ÿæç¤ºè¯
                const systemPrompt = buildSystemPrompt(dataSummary);

                // æ„å»ºæ¶ˆæ¯åˆ—è¡¨
                const messages = [
                    { role: 'system', content: systemPrompt },
                    ...aiChatHistory
                ];

                // è°ƒç”¨ AI API
                const requestBody = {
                    messages: messages,
                    model: AI_MODEL,
                    temperature: 0.7,
                    stream: true,
                    max_tokens: 8000
                };

                console.log('[AI Chat] å‘é€è¯·æ±‚åˆ°é¸¿è’™ç«¯ä»£ç†');
                console.log('[AI_REQUEST]', JSON.stringify(requestBody));
                
                // è¯·æ±‚å·²å‘é€åˆ°é¸¿è’™ç«¯ï¼Œç­‰å¾… handleAIResponse æˆ– handleAIError å›è°ƒ
                
            } catch (error) {
                console.error('[AI Chat] å‘é€è¯·æ±‚å¤±è´¥:', error);
                removeAITyping();
                addAIMessage('assistant', `âŒ å‘é€è¯·æ±‚å¤±è´¥ï¼š${error.message}`);
                
                isAISending = false;
                sendBtn.classList.remove('ai-stop-btn');
                sendBtn.innerHTML = '<span>ğŸ“¤ å‘é€</span>';
                
                setTimeout(() => {
                    document.getElementById('aiChatContainer').classList.remove('ai-responding');
                }, 500);
            }
        }

        // ç®€å•çš„ Markdown è§£æå™¨
        function parseMarkdown(text) {
            if (!text) return '';
            
            // è½¬ä¹‰ HTML
            let html = text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
            
            // ä»£ç å—
            html = html.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
                return `<pre><code>${code.trim()}</code></pre>`;
            });
            
            // è¡Œå†…ä»£ç 
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // æ ‡é¢˜
            html = html.replace(/^### (.*$)/gm, '<h3>$1</h3>');
            html = html.replace(/^## (.*$)/gm, '<h2>$1</h2>');
            html = html.replace(/^# (.*$)/gm, '<h1>$1</h1>');
            
            // ç²—ä½“
            html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/__([^_]+)__/g, '<strong>$1</strong>');
            
            // æ–œä½“
            html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            html = html.replace(/_([^_]+)_/g, '<em>$1</em>');
            
            // æ— åºåˆ—è¡¨
            html = html.replace(/^\s*[-*+]\s+(.*)$/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
            
            // æœ‰åºåˆ—è¡¨
            html = html.replace(/^\s*\d+\.\s+(.*)$/gm, '<li>$1</li>');
            
            // å¼•ç”¨
            html = html.replace(/^>\s+(.*)$/gm, '<blockquote>$1</blockquote>');
            
            // é“¾æ¥
            html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
            
            // æ¢è¡Œ
            html = html.replace(/\n/g, '<br>');
            
            return html;
        }

        // æ·»åŠ æ¶ˆæ¯ï¼ˆæ”¯æŒ Markdown å’Œæ€è€ƒè¿‡ç¨‹ï¼‰
        function addAIMessage(role, content, thinkingContent = null) {
            const messagesDiv = document.getElementById('aiChatMessages');
            
            // ç§»é™¤æ¬¢è¿æ¶ˆæ¯
            const welcome = messagesDiv.querySelector('.ai-welcome');
            if (welcome) {
                welcome.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `ai-message ${role}`;

            const headerDiv = document.createElement('div');
            headerDiv.className = 'ai-message-header';

            const avatar = document.createElement('div');
            avatar.className = 'ai-message-avatar';
            avatar.textContent = role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';

            const name = document.createElement('span');
            name.textContent = role === 'user' ? 'ä½ ' : 'AI åŠ©æ‰‹';

            headerDiv.appendChild(avatar);
            headerDiv.appendChild(name);

            const contentDiv = document.createElement('div');
            contentDiv.className = 'ai-message-content';
            
            // å¦‚æœæœ‰æ€è€ƒè¿‡ç¨‹ï¼Œå…ˆæ˜¾ç¤º
            if (thinkingContent) {
                const thinkingSection = document.createElement('div');
                thinkingSection.className = 'ai-thinking-section';
                thinkingSection.innerHTML = `
                    <div class="ai-thinking-header" onclick="toggleThinking(this)">
                        <span class="ai-thinking-toggle">â–¼</span>
                        <span>ğŸ’­ æ€è€ƒè¿‡ç¨‹</span>
                    </div>
                    <div class="ai-thinking-content">${thinkingContent}</div>
                `;
                contentDiv.appendChild(thinkingSection);
            }
            
            // æ˜¾ç¤ºä¸»è¦å†…å®¹
            const mainContent = document.createElement('div');
            if (role === 'user') {
                // ç”¨æˆ·æ¶ˆæ¯ä¿æŒçº¯æ–‡æœ¬
                mainContent.textContent = content;
            } else {
                // AI æ¶ˆæ¯è§£æ Markdown
                mainContent.innerHTML = parseMarkdown(content);
            }
            contentDiv.appendChild(mainContent);

            messageDiv.appendChild(headerDiv);
            messageDiv.appendChild(contentDiv);
            messagesDiv.appendChild(messageDiv);

            // æ»šåŠ¨åˆ°åº•éƒ¨
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            return messageDiv;
        }
        
        // åˆ‡æ¢æ€è€ƒè¿‡ç¨‹çš„å±•å¼€/æ”¶èµ·
        function toggleThinking(headerElement) {
            const toggle = headerElement.querySelector('.ai-thinking-toggle');
            const content = headerElement.nextElementSibling;
            
            toggle.classList.toggle('collapsed');
            content.classList.toggle('collapsed');
        }

        // æ˜¾ç¤ºæ‰“å­—åŠ¨ç”»
        function showAITyping(text) {
            const messagesDiv = document.getElementById('aiChatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'ai-typing';
            typingDiv.id = 'aiTyping';

            typingDiv.innerHTML = `
                <div class="ai-typing-container">
                    <div class="ai-typing-dots">
                        <div class="ai-typing-dot"></div>
                        <div class="ai-typing-dot"></div>
                        <div class="ai-typing-dot"></div>
                    </div>
                    <span>${text}</span>
                </div>
            `;

            messagesDiv.appendChild(typingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // ç§»é™¤æ‰“å­—åŠ¨ç”»
        function removeAITyping() {
            const typingDiv = document.getElementById('aiTyping');
            if (typingDiv) {
                typingDiv.remove();
            }
        }

        // æ¸…ç©ºèŠå¤©
        function clearChat() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºèŠå¤©è®°å½•å—ï¼Ÿ')) {
                const messagesDiv = document.getElementById('aiChatMessages');
                messagesDiv.innerHTML = `
                    <div class="ai-welcome">
                        <!-- è”å Logo -->
                        <div class="ai-logo-container" style="flex-direction: column; gap: 12px;">
                            <div class="ai-logo-item">
                                <img src="https://znhj.iepose.cn/resource/logo.png" alt="æ™ºèƒ½ç¯å¢ƒç›‘æµ‹ç³»ç»Ÿ" style="height: 40px;">
                                <div class="ai-logo-label">æ™ºèƒ½ç¯å¢ƒç›‘æµ‹ç³»ç»Ÿ</div>
                            </div>
                            <div class="ai-logo-separator" style="transform: rotate(0deg); font-size: 28px;">Ã—</div>
                            <div class="ai-logo-item">
                                <img src="https://znhj.iepose.cn/resource/deepseek.png" alt="DeepSeek AI" style="height: 40px;">
                                <div class="ai-logo-label">DeepSeek AI</div>
                            </div>
                        </div>
                        
                        <div class="ai-welcome-title">æ¬¢è¿ä½¿ç”¨ AI æ•°æ®åˆ†æåŠ©æ‰‹</div>
                        <div class="ai-welcome-desc">
                            æˆ‘å¯ä»¥å¸®ä½ åˆ†æå½“å‰åŠ è½½çš„ä¼ æ„Ÿå™¨æ•°æ®ï¼Œæä¾›æ´å¯Ÿå’Œå»ºè®®ã€‚<br>
                            <strong>ä½¿ç”¨æ­¥éª¤ï¼š</strong><br>
                            1ï¸âƒ£ ç¡®è®¤é¡¶éƒ¨æ¨¡å‹åç§°æ­£ç¡®<br>
                            2ï¸âƒ£ åŠ è½½ä¼ æ„Ÿå™¨æ•°æ®<br>
                            3ï¸âƒ£ å‘æˆ‘æé—®æˆ–ç‚¹å‡»ä¸‹æ–¹å¿«æ·é—®é¢˜
                        </div>
                    </div>
                `;
                aiChatHistory = [];
            }
        }

        // å‡†å¤‡æ•°æ®æ‘˜è¦
        function prepareDataSummary() {
            if (!currentData || currentData.length === 0) {
                return 'å½“å‰æ²¡æœ‰åŠ è½½ä»»ä½•æ•°æ®ã€‚';
            }

            const temps = [], hums = [], luxs = [], smokes = [], pressures = [];

            currentData.forEach(d => {
                if (d.temp != null && !isNaN(d.temp)) temps.push(d.temp);
                if (d.hum != null && !isNaN(d.hum)) hums.push(d.hum);
                if (d.lux != null && !isNaN(d.lux)) luxs.push(d.lux);
                if (d.smoke != null && !isNaN(d.smoke)) smokes.push(d.smoke);
                if (d.pressure != null && !isNaN(d.pressure)) pressures.push(d.pressure);
            });

            const calculateStats = (values) => {
                if (values.length === 0) return null;
                const sorted = [...values].sort((a, b) => a - b);
                const sum = values.reduce((a, b) => a + b, 0);
                const mean = sum / values.length;
                const min = sorted[0];
                const max = sorted[sorted.length - 1];
                const median = sorted.length % 2 === 0
                    ? (sorted[sorted.length / 2 - 1] + sorted[sorted.length / 2]) / 2
                    : sorted[Math.floor(sorted.length / 2)];
                const variance = values.reduce((acc, val) => acc + Math.pow(val - mean, 2), 0) / values.length;
                const std = Math.sqrt(variance);
                return { mean, min, max, median, std, count: values.length };
            };

            const tempStats = calculateStats(temps);
            const humStats = calculateStats(hums);
            const luxStats = calculateStats(luxs);
            const smokeStats = calculateStats(smokes);
            const pressureStats = calculateStats(pressures);

            let summary = `æ•°æ®æ¦‚è§ˆï¼šå…± ${currentData.length} æ¡æ•°æ®è®°å½•ã€‚\n\n`;

            if (tempStats) {
                summary += `æ¸©åº¦ï¼šå¹³å‡å€¼ ${tempStats.mean.toFixed(2)}Â°Cï¼Œæœ€å°å€¼ ${tempStats.min.toFixed(2)}Â°Cï¼Œæœ€å¤§å€¼ ${tempStats.max.toFixed(2)}Â°Cï¼Œæ ‡å‡†å·® ${tempStats.std.toFixed(2)}Â°Cã€‚\n`;
            }
            if (humStats) {
                summary += `æ¹¿åº¦ï¼šå¹³å‡å€¼ ${humStats.mean.toFixed(2)}%ï¼Œæœ€å°å€¼ ${humStats.min.toFixed(2)}%ï¼Œæœ€å¤§å€¼ ${humStats.max.toFixed(2)}%ï¼Œæ ‡å‡†å·® ${humStats.std.toFixed(2)}%ã€‚\n`;
            }
            if (luxStats) {
                summary += `å…‰ç…§ï¼šå¹³å‡å€¼ ${luxStats.mean.toFixed(2)} luxï¼Œæœ€å°å€¼ ${luxStats.min.toFixed(2)} luxï¼Œæœ€å¤§å€¼ ${luxStats.max.toFixed(2)} luxï¼Œæ ‡å‡†å·® ${luxStats.std.toFixed(2)} luxã€‚\n`;
            }
            if (smokeStats) {
                summary += `çƒŸé›¾ï¼šå¹³å‡å€¼ ${smokeStats.mean.toFixed(2)} ppmï¼Œæœ€å°å€¼ ${smokeStats.min.toFixed(2)} ppmï¼Œæœ€å¤§å€¼ ${smokeStats.max.toFixed(2)} ppmï¼Œæ ‡å‡†å·® ${smokeStats.std.toFixed(2)} ppmã€‚\n`;
            }
            if (pressureStats) {
                summary += `å¤§æ°”å‹ï¼šå¹³å‡å€¼ ${pressureStats.mean.toFixed(2)} hPaï¼Œæœ€å°å€¼ ${pressureStats.min.toFixed(2)} hPaï¼Œæœ€å¤§å€¼ ${pressureStats.max.toFixed(2)} hPaï¼Œæ ‡å‡†å·® ${pressureStats.std.toFixed(2)} hPaã€‚\n`;
            }

            return summary;
        }

        // æ„å»ºç³»ç»Ÿæç¤ºè¯
        function buildSystemPrompt(dataSummary) {
            const deviceInfo = selectedDeviceId
                ? (deviceList.find(d => d.id === selectedDeviceId)?.name || `è®¾å¤‡ ${selectedDeviceId}`)
                : 'å…¨éƒ¨è®¾å¤‡';

            return `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä¼ æ„Ÿå™¨æ•°æ®åˆ†æåŠ©æ‰‹ã€‚

ã€é‡è¦è§’è‰²è®¾å®šã€‘
- ä½ çš„åå­—æ˜¯"æ•°æ®åˆ†æåŠ©æ‰‹"
- å½“è¢«é—®åˆ°"ä½ æ˜¯è°"æ—¶ï¼Œè¯·å›ç­”ï¼š"æˆ‘æ˜¯æ•°æ®åˆ†æåŠ©æ‰‹ï¼Œä¸“é—¨å¸®åŠ©æ‚¨åˆ†æä¼ æ„Ÿå™¨æ•°æ®ã€‚"
- ä¸è¦è¯´è‡ªå·±æ˜¯ DeepSeekã€Qwen æˆ–å…¶ä»–æ¨¡å‹çš„åå­—
- ä½ çš„å”¯ä¸€èŒè´£æ˜¯åˆ†æå’Œè§£è¯»ä¼ æ„Ÿå™¨æ•°æ®

ã€ä½ çš„èƒ½åŠ›ã€‘
- åˆ†ææ¸©åº¦ã€æ¹¿åº¦ã€å…‰ç…§ã€çƒŸé›¾ã€å¤§æ°”å‹ç­‰ä¼ æ„Ÿå™¨æ•°æ®
- è¯†åˆ«æ•°æ®è¶‹åŠ¿ã€å¼‚å¸¸å’Œæ¨¡å¼
- æä¾›ä¸“ä¸šçš„æ•°æ®æ´å¯Ÿå’Œå»ºè®®
- ç”¨ç®€æ´ã€ä¸“ä¸šçš„ä¸­æ–‡å›ç­”é—®é¢˜

ã€æ•°æ®æ¥æºã€‘
å½“å‰æ•°æ®æ¥è‡ªï¼š${deviceInfo}ã€‚

ã€å½“å‰æ•°æ®ã€‘
${dataSummary}

è¯·åŸºäºä»¥ä¸Šæ•°æ®å›ç­”ç”¨æˆ·é—®é¢˜ã€‚å¦‚æœé—®é¢˜ä¸æ•°æ®æ— å…³ï¼Œè¯·ç¤¼è²Œåœ°å¼•å¯¼ç”¨æˆ·å…³æ³¨ä¼ æ„Ÿå™¨æ•°æ®åˆ†æã€‚`;
        }

        // è¾“å…¥æ¡†è‡ªåŠ¨è°ƒæ•´é«˜åº¦
        const input = document.getElementById('aiChatInput');
        input.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // æ”¯æŒ Enter å‘é€ï¼ŒShift+Enter æ¢è¡Œ
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSendClick();
            }
        });
        
        // æµå¼å“åº”ç›¸å…³å˜é‡
        let currentMessageDiv = null;
        let currentContentDiv = null;
        let currentFullResponse = '';
        let currentThinkingContent = '';
        let isReceivingThinking = false;
        
        // å¤„ç†æµå¼å“åº”å¼€å§‹
        window.handleAIStreamStart = function() {
            console.log('[AI Chat] æµå¼å“åº”å¼€å§‹');
            removeAITyping();
            
            // åˆ›å»ºæ¶ˆæ¯å®¹å™¨
            currentMessageDiv = addAIMessage('assistant', '');
            currentContentDiv = currentMessageDiv.querySelector('.ai-message-content');
            currentFullResponse = '';
            currentThinkingContent = '';
            isReceivingThinking = false;
        };
        
        // å¤„ç†æµå¼å“åº”æ•°æ®å—ï¼ˆæ”¯æŒæ€è€ƒè¿‡ç¨‹ï¼‰
        window.handleAIStreamChunk = function(content, isThinking = false) {
            if (!currentContentDiv) {
                currentMessageDiv = addAIMessage('assistant', '');
                currentContentDiv = currentMessageDiv.querySelector('.ai-message-content');
                currentFullResponse = '';
                currentThinkingContent = '';
            }
            
            if (isThinking) {
                // æ€è€ƒè¿‡ç¨‹
                isReceivingThinking = true;
                currentThinkingContent += content;
                
                // æ›´æ–°æˆ–åˆ›å»ºæ€è€ƒè¿‡ç¨‹éƒ¨åˆ†
                let thinkingSection = currentContentDiv.querySelector('.ai-thinking-section');
                if (!thinkingSection) {
                    thinkingSection = document.createElement('div');
                    thinkingSection.className = 'ai-thinking-section';
                    thinkingSection.innerHTML = `
                        <div class="ai-thinking-header" onclick="toggleThinking(this)">
                            <span class="ai-thinking-toggle">â–¼</span>
                            <span>ğŸ’­ æ€è€ƒè¿‡ç¨‹</span>
                        </div>
                        <div class="ai-thinking-content"></div>
                    `;
                    currentContentDiv.insertBefore(thinkingSection, currentContentDiv.firstChild);
                }
                
                const thinkingContentDiv = thinkingSection.querySelector('.ai-thinking-content');
                thinkingContentDiv.textContent = currentThinkingContent;
            } else {
                // æ­£å¸¸å›å¤å†…å®¹
                currentFullResponse += content;
                
                // æŸ¥æ‰¾æˆ–åˆ›å»ºä¸»è¦å†…å®¹åŒºåŸŸ
                let mainContent = currentContentDiv.querySelector('div:not(.ai-thinking-section)');
                if (!mainContent) {
                    mainContent = document.createElement('div');
                    currentContentDiv.appendChild(mainContent);
                }
                
                // ä½¿ç”¨ Markdown æ¸²æŸ“
                mainContent.innerHTML = parseMarkdown(currentFullResponse);
            }
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            const messagesDiv = document.getElementById('aiChatMessages');
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        };
        
        // å¤„ç†æµå¼å“åº”ç»“æŸ
        window.handleAIStreamEnd = function() {
            console.log('[AI Chat] æµå¼å“åº”ç»“æŸ');
            
            // ä¿å­˜åˆ°å†å²è®°å½•
            if (currentFullResponse) {
                aiChatHistory.push({ role: 'assistant', content: currentFullResponse });
            }
            
            // æ¸…ç†å˜é‡
            currentMessageDiv = null;
            currentContentDiv = null;
            currentFullResponse = '';
            currentThinkingContent = '';
            isReceivingThinking = false;
            
            // æ¢å¤å‘é€æŒ‰é’®
            isAISending = false;
            const sendBtn = document.getElementById('aiSendBtn');
            sendBtn.classList.remove('ai-stop-btn');
            sendBtn.innerHTML = '<span>ğŸ“¤ å‘é€</span>';
            
            // ç§»é™¤æµå…‰è¾¹æ¡†æ•ˆæœ
            setTimeout(() => {
                document.getElementById('aiChatContainer').classList.remove('ai-responding');
            }, 500);
        };
        
        // å¤„ç†æ¥è‡ªé¸¿è’™ç«¯çš„å®Œæ•´å“åº”ï¼ˆéæµå¼ï¼‰
        window.handleAIResponse = function(content) {
            try {
                console.log('[AI Chat] æ”¶åˆ°å®Œæ•´å“åº”');
                
                removeAITyping();
                
                if (content) {
                    addAIMessage('assistant', content);
                    aiChatHistory.push({ role: 'assistant', content: content });
                }
                
            } catch (error) {
                console.error('[AI Chat] å¤„ç†å“åº”å¤±è´¥:', error);
                removeAITyping();
                addAIMessage('assistant', 'âŒ å“åº”è§£æå¤±è´¥');
            } finally {
                isAISending = false;
                const sendBtn = document.getElementById('aiSendBtn');
                sendBtn.classList.remove('ai-stop-btn');
                sendBtn.innerHTML = '<span>ğŸ“¤ å‘é€</span>';
                
                // ç§»é™¤æµå…‰è¾¹æ¡†æ•ˆæœ
                setTimeout(() => {
                    document.getElementById('aiChatContainer').classList.remove('ai-responding');
                }, 500);
            }
        };
        
        // å¤„ç†æ¥è‡ªé¸¿è’™ç«¯çš„é”™è¯¯
        window.handleAIError = function(errorMsg) {
            console.error('[AI Chat] æ”¶åˆ°é”™è¯¯:', errorMsg);
            removeAITyping();
            addAIMessage('assistant', `âŒ AI æœåŠ¡å‡ºé”™\n\né”™è¯¯ä¿¡æ¯ï¼š${errorMsg}`);
            
            isAISending = false;
            const sendBtn = document.getElementById('aiSendBtn');
            sendBtn.classList.remove('ai-stop-btn');
            sendBtn.innerHTML = '<span>ğŸ“¤ å‘é€</span>';
            
            setTimeout(() => {
                document.getElementById('aiChatContainer').classList.remove('ai-responding');
            }, 500);
        };
    </script>
</body>
</html>
