import http from '@ohos.net.http';
import promptAction from '@ohos.promptAction';
// è¯·ç¡®ä¿è¿™äº›å¼•ç”¨è·¯å¾„åœ¨ä½ é¡¹ç›®ä¸­æ˜¯æ­£ç¡®çš„
import { SensorData } from './DeviceDetailPageLogic';
import { SERVER_HOST } from './WebSocketManager';
import { DeviceInfo } from './DevicesPageLogic';
import { LoadMode, TimeUnit, LoadParams, DataLoadCallback } from './DataLoadComponent';

// ----------------------------------------------------------------
// 1. æ•°æ®åŠ è½½é€»è¾‘ç±» (ä¿æŒä¸å˜)
// ----------------------------------------------------------------
class AnalysisDataLoader {
  private deviceId: string | null; // nullè¡¨ç¤ºå…¨éƒ¨è®¾å¤‡
  private callback: DataLoadCallback;

  constructor(deviceId: string | null, callback: DataLoadCallback) {
    this.deviceId = deviceId;
    this.callback = callback;
  }

  getDeviceId(): string | null {
    return this.deviceId;
  }

  async load(params: LoadParams): Promise<void> {
    try {
      let url = `http://${SERVER_HOST}/api/history`;
      const queryParams: string[] = [];

      if (this.deviceId) {
        queryParams.push(`device_id=${this.deviceId}`);
      }

      switch (params.mode) {
        case LoadMode.COUNT:
          if (params.count !== undefined && params.count > 0) {
            queryParams.push(`limit=${params.count}`);
          }
          break;

        case LoadMode.TIME:
          if (params.timeValue !== undefined && params.timeUnit !== undefined) {
            const now = Date.now() / 1000;
            let startTime = now;
            switch (params.timeUnit) {
              case TimeUnit.MINUTE: startTime = now - params.timeValue * 60; break;
              case TimeUnit.HOUR: startTime = now - params.timeValue * 3600; break;
              case TimeUnit.DAY: startTime = now - params.timeValue * 86400; break;
              case TimeUnit.MONTH: startTime = now - params.timeValue * 2592000; break;
            }
            url = `http://${SERVER_HOST}/api/history/range`;
            queryParams.push(`start=${startTime}`);
            queryParams.push(`end=${now}`);
          }
          break;

        case LoadMode.RANGE:
          if (params.startTime !== undefined && params.endTime !== undefined) {
            url = `http://${SERVER_HOST}/api/history/range`;
            queryParams.push(`start=${params.startTime}`);
            queryParams.push(`end=${params.endTime}`);
          }
          break;

        case LoadMode.ALL:
          queryParams.push('limit=-1');
          break;
      }

      if (queryParams.length > 0) {
        url += '?' + queryParams.join('&');
      }

      console.info(`å¼€å§‹åŠ è½½æ•°æ®: ${url}`);
      const httpRequest: http.HttpRequest = http.createHttp();
      const response: http.HttpResponse = await httpRequest.request(url, {
        method: http.RequestMethod.GET,
        header: { 'Content-Type': 'application/json' }
      });

      httpRequest.destroy();

      if (response && response.responseCode === 200) {
        const result = JSON.parse(response.result as string) as Record<string, Object>;
        if (result['success'] === true && result['data']) {
          const dataArray = result['data'] as Array<Record<string, Object>>;
          const historyData: SensorData[] = [];
          dataArray.forEach((item: Record<string, Object>) => {
            if (item['type'] === 'reading') {
              historyData.push({
                ts: item['ts'] as number,
                temp: item['temp'] as number,
                hum: item['hum'] as number,
                lux: item['lux'] as number,
                smoke: item['smoke'] as number,
                pressure: item['pressure'] as number,
                temp2: item['temp2'] as number,
                rs_ro: item['rs_ro'] as number,
                device_id: item['device_id'] as string | undefined
              });
            }
          });
          this.callback.onDataLoaded(historyData, historyData.length);
        } else {
          const error = 'æ•°æ®åŠ è½½å¤±è´¥æˆ–æ— æ•°æ®';
          if (this.callback.onLoadError) this.callback.onLoadError(error);
        }
      } else {
        const error = `HTTPè¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : ${response?.responseCode}`;
        if (this.callback.onLoadError) this.callback.onLoadError(error);
      }
    } catch (err) {
      const error = `æ•°æ®åŠ è½½å¼‚å¸¸: ${err}`;
      if (this.callback.onLoadError) this.callback.onLoadError(error);
    }
  }
}

// ----------------------------------------------------------------
// 2. åˆ†æé¡µæ•°æ®åŠ è½½ç»„ä»¶
// ----------------------------------------------------------------
@ComponentV2
export struct AnalysisDataLoadComponent {
  @Require @Param deviceList: DeviceInfo[];
  @Require @Param selectedDeviceId: string | null;
  @Require @Param onDeviceChanged: (deviceId: string | null) => void;
  @Require @Param onDataLoaded: (data: SensorData[], count: number) => void;
  @Param shouldBounce: boolean = false; // æ§åˆ¶æŒ‰é’®å¼¹è·³åŠ¨ç”»

  @Local showLoadPanel: boolean = false;
  @Local showModeSelection: boolean = true;
  @Local selectedMode: LoadMode = LoadMode.COUNT;
  @Local loadCount: number = 1000;
  @Local timeValue: number = 1;
  @Local timeUnit: TimeUnit = TimeUnit.HOUR;
  @Local startDate: Date = new Date(Date.now() - 86400000);
  @Local endDate: Date = new Date();
  @Local isLoading: boolean = false;

  private loader: AnalysisDataLoader | null = null;

  aboutToAppear(): void {
    this.createLoader();
  }

  private createLoader(): void {
    this.loader = new AnalysisDataLoader(this.selectedDeviceId, {
      onDataLoaded: (data: SensorData[], count: number) => {
        this.isLoading = false;
        this.showLoadPanel = false;
        this.showModeSelection = true;
        try {
          promptAction.showToast({ message: `æˆåŠŸåŠ è½½ ${count} æ¡æ•°æ®`, duration: 2000 });
        } catch (e) {
          console.error('æ˜¾ç¤ºToastå¤±è´¥:', e);
        }
        this.onDataLoaded(data, count);
      },
      onLoadError: (error: string) => {
        this.isLoading = false;
        try {
          promptAction.showToast({ message: `åŠ è½½å¤±è´¥: ${error}`, duration: 2000 });
        } catch (e) {
          console.error('æ˜¾ç¤ºToastå¤±è´¥:', e);
        }
      }
    });
  }

  private async executeLoad(): Promise<void> {
    if (this.isLoading || !this.loader) return;
    if (this.loader && this.loader.getDeviceId() !== this.selectedDeviceId) {
      this.createLoader();
    }
    this.isLoading = true;
    const params: LoadParams = { mode: this.selectedMode };
    switch (this.selectedMode) {
      case LoadMode.COUNT: params.count = this.loadCount; break;
      case LoadMode.TIME: params.timeValue = this.timeValue; params.timeUnit = this.timeUnit; break;
      case LoadMode.RANGE:
        params.startTime = Math.floor(this.startDate.getTime() / 1000);
        params.endTime = Math.floor(this.endDate.getTime() / 1000);
        break;
      case LoadMode.ALL: break;
    }
    await this.loader.load(params);
  }

  build() {
    Column({ space: 12 }) {
      // 1. è®¾å¤‡é€‰æ‹©
      Column({ space: 8 }) {
        Text('è®¾å¤‡é€‰æ‹©')
          .fontSize(14)
          .fontColor($r("app.color.home_title_text"))
          .width('100%')

        Select(this.getDeviceOptions())
          .selected(this.getSelectedDeviceIndex())
          .value(this.getSelectedDeviceText())
          .width('100%')
          .onSelect((index: number) => {
            if (index === 0) this.onDeviceChanged(null);
            else {
              const device = this.deviceList[index - 1];
              this.onDeviceChanged(device.id || device.device_id || null);
            }
            this.createLoader();
          })
      }
      .width('100%')

      // 2. åŠ è½½æŒ‰é’® (ç»‘å®šå¼¹çª— + å¼¹è·³åŠ¨ç”»)
      Button('ğŸ“¥ åŠ è½½æ•°æ®')
        .width('100%')
        .fontSize(14)
        .fontColor(Color.White)
        .backgroundColor(this.shouldBounce ? '#ff6b6b' : '#2563eb')
        .scale({ 
          x: this.shouldBounce ? 1.05 : 1, 
          y: this.shouldBounce ? 1.05 : 1 
        })
        .shadow({
          radius: this.shouldBounce ? 12 : 4,
          color: this.shouldBounce ? '#4Fff6b6b' : '#1F2563eb',
          offsetX: 0,
          offsetY: 2
        })
        .animation({
          duration: 300,
          curve: Curve.EaseInOut,
          iterations: this.shouldBounce ? 3 : 1,
          playMode: PlayMode.Alternate
        })
        .onClick(() => {
          this.showModeSelection = true;
          this.showLoadPanel = true;
        })
        .bindSheet(this.showLoadPanel, this.buildLoadPanel(), {
          height: SheetSize.MEDIUM,
          dragBar: true,
          backgroundColor: $r("app.color.home_card_background"),
          onDisappear: () => {
            this.showLoadPanel = false;
          }
        })
    }
    .width('100%')
  }

  // --- å¼¹çª—é¢æ¿ (å·²ä¿®æ”¹æ ‡é¢˜æ ) ---
  @Builder
  buildLoadPanel() {
    Column() {
      // æ ‡é¢˜æ ï¼šåªä¿ç•™ä¸€ä¸ª X
      Row() {
        Text('ğŸ“Š åŠ è½½å†å²æ•°æ®')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor($r("app.color.home_value_text"))
          // .layoutWeight(1)
      }
      .width('100%')
      .alignItems(VerticalAlign.Center)
      .padding({ top: 20, bottom: 12, left: 20, right: 10 }) // å³ä¾§paddingå‡å°ï¼Œå› ä¸ºXè‡ªå¸¦å®½åº¦
      // .border({ width: { bottom: 1 }, color: '#F0F0F0' })

      Scroll() {
        Column({ space: 16 }) {
          if (this.showModeSelection) {
            this.buildModeSelection()
          } else {
            this.buildDetailForm()
          }
        }
        .padding(20)
      }
      .layoutWeight(1)
      .width('100%')

      if (!this.showModeSelection) {
        Row({ space: 12 }) {
          Button('ä¸Šä¸€æ­¥')
            .fontColor('#2563eb')
            .backgroundColor(Color.Transparent)
            .layoutWeight(1)
            .onClick(() => {
              this.showModeSelection = true;
            })

          Button(this.isLoading ? 'åŠ è½½ä¸­...' : 'å¼€å§‹åŠ è½½')
            .fontColor(Color.White)
            .backgroundColor('#2563eb')
            .layoutWeight(2)
            .enabled(!this.isLoading)
            .onClick(() => {
              this.executeLoad();
            })
        }
        .padding(16)
        .width('100%')
        .backgroundColor($r("app.color.home_card_background"))
        .border({ width: { top: 1 }, color: '#F0F0F0' })
      }
    }
    .width('100%')
    .height('100%')
  }

  // --- è¾…åŠ©æ–¹æ³• (ä¿æŒä¸å˜) ---

  @Builder
  buildDetailForm() {
    Column({ space: 20 }) {
      if (this.selectedMode === LoadMode.COUNT) {
        this.buildCountForm()
      } else if (this.selectedMode === LoadMode.TIME) {
        this.buildTimeForm()
      } else if (this.selectedMode === LoadMode.RANGE) {
        this.buildRangeForm()
      }
    }
  }

  @Builder
  buildModeSelection() {
    Column({ space: 12 }) {
      this.buildModeOption('ğŸ“', 'æŒ‰æœ€è¿‘æ¡æ•°åŠ è½½', 'åŠ è½½æœ€è¿‘çš„Næ¡æ•°æ®è®°å½•', () => {
        this.selectedMode = LoadMode.COUNT;
        this.showModeSelection = false;
      })
      this.buildModeOption('â±ï¸', 'æŒ‰æœ€è¿‘æ—¶é—´åŠ è½½', 'åŠ è½½æœ€è¿‘å‡ åˆ†é’Ÿ/å°æ—¶/å¤©/æœˆçš„æ•°æ®', () => {
        this.selectedMode = LoadMode.TIME;
        this.showModeSelection = false;
      })
      this.buildModeOption('ğŸ“…', 'è‡ªå®šä¹‰æ—¶é—´èŒƒå›´', 'é€‰æ‹©å¼€å§‹å’Œç»“æŸæ—¶é—´ï¼Œç²¾ç¡®åŠ è½½', () => {
        this.selectedMode = LoadMode.RANGE;
        this.showModeSelection = false;
      })
      this.buildModeOption('âš ï¸', 'åŠ è½½å…¨éƒ¨æ•°æ®', 'åŠ è½½æ•°æ®åº“ä¸­çš„æ‰€æœ‰å†å²æ•°æ®', () => {
        this.selectedMode = LoadMode.ALL;
        this.executeLoad();
      })
    }
  }

  @Builder
  buildModeOption(icon: string, title: string, desc: string, onClick: () => void) {
    Row() {
      Column({ space: 4 }) {
        Row({ space: 8 }) {
          Text(icon).fontSize(20)
          Text(title)
            .fontSize(15)
            .fontWeight(FontWeight.Medium)
            .fontColor($r("app.color.home_value_text"))
        }
        Text(desc)
          .fontSize(12)
          .fontColor($r("app.color.home_status_text"))
          .margin({ top: 4 })
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)

      Text('â€º')
        .fontSize(24)
        .fontColor($r("app.color.home_status_text"))
        .fontWeight(FontWeight.Lighter)
    }
    .width('100%')
    .padding(16)
    .borderRadius(12)
    .borderWidth(1)
    .borderColor($r("app.color.home_card_border"))
    .backgroundColor($r("app.color.home_card_background"))
    .onClick(onClick)
  }

  @Builder
  buildCountForm() {
    Column({ space: 16 }) {
      Text('æ•°æ®æ¡æ•°').fontSize(14).fontColor($r("app.color.home_title_text")).width('100%')
      Row({ space: 8 }) {
        TextInput({ text: this.loadCount.toString() })
          .type(InputType.Number)
          .fontSize(14)
          .layoutWeight(1)
          .onChange((value: string) => {
            const num = parseInt(value);
            if (!isNaN(num) && num > 0) this.loadCount = num;
          })
        Text('æ¡').fontSize(14).fontColor($r("app.color.home_status_text"))
      }
      .width('100%')
    }
  }

  @Builder
  buildTimeForm() {
    Column({ space: 16 }) {
      Text('æ—¶é—´æ•°é‡').fontSize(14).fontColor($r("app.color.home_title_text")).width('100%')
      Row({ space: 8 }) {
        TextInput({ text: this.timeValue.toString() })
          .type(InputType.Number)
          .fontSize(14)
          .width(100)
          .onChange((value: string) => {
            const num = parseInt(value);
            if (!isNaN(num) && num > 0) this.timeValue = num;
          })
        Select(this.getTimeUnitOptions())
          .selected(1)
          .value(this.getTimeUnitText())
          .layoutWeight(1)
          .zIndex(1000)
          .onSelect((index: number) => {
            switch (index) {
              case 0: this.timeUnit = TimeUnit.MINUTE; break;
              case 1: this.timeUnit = TimeUnit.HOUR; break;
              case 2: this.timeUnit = TimeUnit.DAY; break;
              case 3: this.timeUnit = TimeUnit.MONTH; break;
            }
          })
      }
      .width('100%')
    }
  }

  @Builder
  buildRangeForm() {
    Column({ space: 16 }) {
      Column({ space: 8 }) {
        Text('å¼€å§‹æ—¶é—´').fontSize(14).fontColor($r("app.color.home_title_text")).width('100%')
        DatePicker({ start: new Date('2020-01-01'), end: new Date(), selected: this.startDate })
          .onDateChange((value: Date) => { this.startDate = value; })
      }
      Column({ space: 8 }) {
        Text('ç»“æŸæ—¶é—´').fontSize(14).fontColor($r("app.color.home_title_text")).width('100%')
        DatePicker({ start: new Date('2020-01-01'), end: new Date(), selected: this.endDate })
          .onDateChange((value: Date) => { this.endDate = value; })
      }
    }
  }

  private getDeviceOptions(): Array<SelectOption> {
    const options: Array<SelectOption> = [];
    const allDeviceOption: SelectOption = { value: 'å…¨éƒ¨è®¾å¤‡', icon: '' };
    options.push(allDeviceOption);
    this.deviceList.forEach(device => {
      const name = device.name || `è®¾å¤‡ ${device.id || device.device_id}`;
      const deviceOption: SelectOption = { value: name, icon: '' };
      options.push(deviceOption);
    });
    return options;
  }

  private getSelectedDeviceIndex(): number {
    if (!this.selectedDeviceId) return 0;
    const index = this.deviceList.findIndex(device =>
    (device.id || device.device_id || '').trim().toUpperCase() === this.selectedDeviceId?.trim().toUpperCase()
    );
    return index >= 0 ? index + 1 : 0;
  }

  private getSelectedDeviceText(): string {
    if (!this.selectedDeviceId) return 'å…¨éƒ¨è®¾å¤‡';
    const device = this.deviceList.find(d =>
    (d.id || d.device_id || '').trim().toUpperCase() === this.selectedDeviceId?.trim().toUpperCase()
    );
    return device ? (device.name || `è®¾å¤‡ ${device.id || device.device_id}`) : 'å…¨éƒ¨è®¾å¤‡';
  }

  private getTimeUnitText(): string {
    switch (this.timeUnit) {
      case TimeUnit.MINUTE: return 'åˆ†é’Ÿ';
      case TimeUnit.HOUR: return 'å°æ—¶';
      case TimeUnit.DAY: return 'å¤©';
      case TimeUnit.MONTH: return 'æœˆ';
      default: return 'å°æ—¶';
    }
  }

  private getTimeUnitOptions(): Array<SelectOption> {
    return [
      { value: 'åˆ†é’Ÿ', icon: '' },
      { value: 'å°æ—¶', icon: '' },
      { value: 'å¤©', icon: '' },
      { value: 'æœˆ', icon: '' }
    ];
  }
}